<html>
<head>
  <meta charset="utf-8">
  <div id="mapdiv"></div>
  <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
  <script type="text/javascript" src="http://maplib.khtml.org/khtml.maplib/khtml_all.js"> </script>
  <script type="text/javascript" src="loadxmldoc.js"></script>
  <script>
      try{
          xmlDoc = loadXMLDoc("markers.xml")
      }
      catch(err)
      {
          txt="An error occurred while trying to read dumped pyrocko marker.\n\n";
          txt+="Probably, your browser does not allow to open that document\n\n";
          txt+="due to the \"Same-Origin-Policy\".\n\n";
          txt+="A solution might be to change your default browser.\n\n";
          alert(txt);
      }

      function station(lat, lon, icon_data){
          this.lat = lat;
          this.lon = lon;
          this.base(lat, lon, icon_data)
      };

      function Event(lat, lon, time, depth, magnitude, icon_data){
          this.lat = lat;
          this.lon = lon;
          this.time = time || 0;
          this.depth = depth || 0;
          this.magnitude = magnitude || 0;
          this.icon_data = icon_data || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAbUlEQVQ4ja3OOwrAMAwDUN0rHXzzHK1dQnGJ68gfgTYhHsDlAjDILZW52hIBcK9Kx+FUh2WlqLMWpdaVlZaupLR0aaWnSyk9XVjJ6EJKRkcrIzpKGdEdlRmdq8zofpUVnams6DZlh+6j7NC9ygd+w8cw2AIG3AAAAABJRU5ErkJggg==';
      };

      function myxmlExtractor(xmlDoc){
          deb = xmlDoc.getElementsByTagName("event")
          var events = [];
          for (i=0; i<deb.length; i++)
          {
              var lat = deb[i].childNodes[3].firstChild.data;
              var lon = deb[i].childNodes[5].firstChild.data;
              var time = deb[i].childNodes[7].firstChild.data;
              var depth = deb[i].childNodes[11].firstChild.data;
              try {
                  var mag = deb[i].childNodes[9].firstChild.data;
              }
              catch (e) {
                  var mag = 0;
              }
              var event = new Event(lat,
                                    lon,
                                    time,
                                    depth,
                                    mag);

              events[events.length] = event;
          };

          var stations = [];
          stationElements=xmlDoc.getElementsByTagName("station")
          for (i=0; i<stationElements.length; i++)
          {
              var nsl = stationElements[i].childNodes[1].firstChild.data;
              var lat = stationElements[i].childNodes[3].firstChild.data;
              var lon = stationElements[i].childNodes[5].firstChild.data;
              var station = {lat:lat,
                             lon:lon, 
                             nsl:nsl,
                             icon_data:null};

              stations[stations.length] = station;
          } 
          return [stations, events]
      };

      function add_markers(map, items){
          var markers = new OpenLayers.Layer.Markers( "Markers" );
          var size = new OpenLayers.Size(21,25);
          var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
          for (i=0; i<items.length; i++){
              var ev = items[i];
              var icon = new OpenLayers.Icon(ev.icon_data, size, offset);
              var lonLat = new OpenLayers.LonLat(ev.lon, ev.lat);
              lonLat.transform(new OpenLayers.Projection("EPSG:4326"),
                               map.getProjectionObject());
              markers.addMarker(new OpenLayers.Marker(lonLat, icon.clone()));
          };
          map.addLayer(markers);
          return markers;
      }

      function zoomToExtent(map, layers) {
          bounds = new OpenLayers.Bounds();
          for (i=0; i<layers.length; i++){
              bounds.extend(layers[i].getDataExtent());
          }
          map.zoomToExtent(bounds);
      }


      function init() {
          map = new OpenLayers.Map("mapdiv");
          map.addLayer(new OpenLayers.Layer.OSM());
          epsg4326 = new OpenLayers.Projection("EPSG:4326");
          projectTo = map.getProjectionObject();
          var stations_events = myxmlExtractor(xmlDoc);
          var stations = stations_events[0];
          var events = stations_events[1];
          var event_makers = add_markers(map, events);
          var station_markers = add_markers(map, stations);
          zoomToExtent(map, [station_markers, event_makers])
      }

</script>
</head>
<body onload="init()">
</body></html>
